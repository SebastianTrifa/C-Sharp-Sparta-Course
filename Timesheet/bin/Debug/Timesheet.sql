/*
Deployment script for Timesheet

This code was generated by a tool.
Changes to this file may cause incorrect behavior and will be lost if
the code is regenerated.
*/

GO
SET ANSI_NULLS, ANSI_PADDING, ANSI_WARNINGS, ARITHABORT, CONCAT_NULL_YIELDS_NULL, QUOTED_IDENTIFIER ON;

SET NUMERIC_ROUNDABORT OFF;


GO
:setvar DatabaseName "Timesheet"
:setvar DefaultFilePrefix "Timesheet"
:setvar DefaultDataPath "C:\Users\STrifa\AppData\Local\Microsoft\VisualStudio\SSDT\Labs"
:setvar DefaultLogPath "C:\Users\STrifa\AppData\Local\Microsoft\VisualStudio\SSDT\Labs"

GO
:on error exit
GO
/*
Detect SQLCMD mode and disable script execution if SQLCMD mode is not supported.
To re-enable the script after enabling SQLCMD mode, execute the following:
SET NOEXEC OFF; 
*/
:setvar __IsSqlCmdEnabled "True"
GO
IF N'$(__IsSqlCmdEnabled)' NOT LIKE N'True'
    BEGIN
        PRINT N'SQLCMD mode must be enabled to successfully execute this script.';
        SET NOEXEC ON;
    END


GO
USE [$(DatabaseName)];


GO
IF EXISTS (SELECT 1
           FROM   [master].[dbo].[sysdatabases]
           WHERE  [name] = N'$(DatabaseName)')
    BEGIN
        ALTER DATABASE [$(DatabaseName)]
            SET ARITHABORT ON,
                CONCAT_NULL_YIELDS_NULL ON,
                CURSOR_DEFAULT LOCAL 
            WITH ROLLBACK IMMEDIATE;
    END


GO
IF EXISTS (SELECT 1
           FROM   [master].[dbo].[sysdatabases]
           WHERE  [name] = N'$(DatabaseName)')
    BEGIN
        ALTER DATABASE [$(DatabaseName)]
            SET PAGE_VERIFY NONE,
                DISABLE_BROKER 
            WITH ROLLBACK IMMEDIATE;
    END


GO
ALTER DATABASE [$(DatabaseName)]
    SET TARGET_RECOVERY_TIME = 0 SECONDS 
    WITH ROLLBACK IMMEDIATE;


GO
IF EXISTS (SELECT 1
           FROM   [master].[dbo].[sysdatabases]
           WHERE  [name] = N'$(DatabaseName)')
    BEGIN
        ALTER DATABASE [$(DatabaseName)]
            SET QUERY_STORE (CLEANUP_POLICY = (STALE_QUERY_THRESHOLD_DAYS = 367)) 
            WITH ROLLBACK IMMEDIATE;
    END


GO
PRINT N'Rename refactoring operation with key fb06cac1-6bc8-4a62-a709-3e0c5ec0fe29 is skipped, element [dbo].[Project_Relationships].[Id] (SqlSimpleColumn) will not be renamed to Relationship_Id';


GO
PRINT N'Rename refactoring operation with key 7aee1f85-891b-4139-bc27-d9759cd7907d is skipped, element [dbo].[Timesheets].[Id] (SqlSimpleColumn) will not be renamed to TImesheet_Id';


GO
PRINT N'Rename refactoring operation with key 900b535f-8a27-4845-8db6-507287b08962 is skipped, element [dbo].[Projects].[Id] (SqlSimpleColumn) will not be renamed to Project_Id';


GO
PRINT N'Rename refactoring operation with key 4037b5f7-269d-42a4-a451-aeb4c59565a7 is skipped, element [dbo].[WorkTypes].[Id] (SqlSimpleColumn) will not be renamed to Work_Id';


GO
PRINT N'Rename refactoring operation with key 06b6afe4-064c-476f-8889-cc0a617ee859 is skipped, element [dbo].[Projects].[WorkType] (SqlSimpleColumn) will not be renamed to Work_Id';


GO
PRINT N'Rename refactoring operation with key ba311bd0-cd3e-4370-984b-f42d3fed55fe is skipped, element [dbo].[Users].[Password] (SqlSimpleColumn) will not be renamed to Password_Hash';


GO
PRINT N'Rename refactoring operation with key f9c4a3aa-7e64-4011-b229-46faf411aafd, 997e0375-919c-4498-ae0e-abdec281b126 is skipped, element [dbo].[Users].[Id] (SqlSimpleColumn) will not be renamed to User_Id';


GO
PRINT N'Rename refactoring operation with key 9df434b3-0abc-4e53-90bc-4366ba924577 is skipped, element [dbo].[Projects].[Manger_Id] (SqlSimpleColumn) will not be renamed to Manager_Id';


GO
PRINT N'Creating [dbo].[Projects]...';


GO
CREATE TABLE [dbo].[Projects] (
    [Project_Id] INT        IDENTITY (1, 1) NOT NULL,
    [Manager_Id] INT        NOT NULL,
    [Proj_Desc]  NTEXT      NULL,
    [Proj_Name]  NCHAR (20) NOT NULL,
    [WorKType]   NCHAR (20) NULL,
    [Parent_Id]  INT        NULL,
    CONSTRAINT [PK_PROJECTS] PRIMARY KEY CLUSTERED ([Project_Id] ASC)
);


GO
PRINT N'Creating [dbo].[Timesheets]...';


GO
CREATE TABLE [dbo].[Timesheets] (
    [Timesheet_Id]      INT      NOT NULL,
    [Start_Date]        DATETIME NOT NULL,
    [Hours_Worked]      INT      NOT NULL,
    [User_Id]           INT      NOT NULL,
    [ApprovedBy_UserId] INT      NOT NULL,
    [Project_Id]        INT      NOT NULL,
    CONSTRAINT [PK_TIMESHEETS] PRIMARY KEY CLUSTERED ([Timesheet_Id] ASC)
);


GO
PRINT N'Creating [dbo].[Users]...';


GO
CREATE TABLE [dbo].[Users] (
    [User_Id]       INT        NOT NULL,
    [First_Name]    CHAR (10)  NULL,
    [Last_Name]     CHAR (10)  NULL,
    [Email]         NCHAR (30) NOT NULL,
    [Password_Hash] NCHAR (20) NOT NULL,
    [Username]      NCHAR (20) NOT NULL,
    [Project_Id]    INT        NULL,
    CONSTRAINT [PK_USERS] PRIMARY KEY CLUSTERED ([User_Id] ASC)
);


GO
PRINT N'Creating unnamed constraint on [dbo].[Timesheets]...';


GO
ALTER TABLE [dbo].[Timesheets]
    ADD DEFAULT 0 FOR [Hours_Worked];


GO
PRINT N'Creating [dbo].[FK_PROJECTS_MANAGER]...';


GO
ALTER TABLE [dbo].[Projects] WITH NOCHECK
    ADD CONSTRAINT [FK_PROJECTS_MANAGER] FOREIGN KEY ([Manager_Id]) REFERENCES [dbo].[Users] ([User_Id]);


GO
PRINT N'Creating [dbo].[FK_PROJECTS_PROJECTS]...';


GO
ALTER TABLE [dbo].[Projects] WITH NOCHECK
    ADD CONSTRAINT [FK_PROJECTS_PROJECTS] FOREIGN KEY ([Parent_Id]) REFERENCES [dbo].[Projects] ([Project_Id]);


GO
PRINT N'Creating [dbo].[FK_TIMESHEETS_PROJECTS]...';


GO
ALTER TABLE [dbo].[Timesheets] WITH NOCHECK
    ADD CONSTRAINT [FK_TIMESHEETS_PROJECTS] FOREIGN KEY ([Project_Id]) REFERENCES [dbo].[Projects] ([Project_Id]);


GO
PRINT N'Creating [dbo].[FK_TIMESHEETS_MANAGERS]...';


GO
ALTER TABLE [dbo].[Timesheets] WITH NOCHECK
    ADD CONSTRAINT [FK_TIMESHEETS_MANAGERS] FOREIGN KEY ([ApprovedBy_UserId]) REFERENCES [dbo].[Users] ([User_Id]);


GO
PRINT N'Creating [dbo].[FK_TIMESHEETS_USERS]...';


GO
ALTER TABLE [dbo].[Timesheets] WITH NOCHECK
    ADD CONSTRAINT [FK_TIMESHEETS_USERS] FOREIGN KEY ([User_Id]) REFERENCES [dbo].[Users] ([User_Id]);


GO
PRINT N'Creating [dbo].[FK_USERS_PROJECT]...';


GO
ALTER TABLE [dbo].[Users] WITH NOCHECK
    ADD CONSTRAINT [FK_USERS_PROJECT] FOREIGN KEY ([Project_Id]) REFERENCES [dbo].[Projects] ([Project_Id]);


GO
-- Refactoring step to update target server with deployed transaction logs

IF OBJECT_ID(N'dbo.__RefactorLog') IS NULL
BEGIN
    CREATE TABLE [dbo].[__RefactorLog] (OperationKey UNIQUEIDENTIFIER NOT NULL PRIMARY KEY)
    EXEC sp_addextendedproperty N'microsoft_database_tools_support', N'refactoring log', N'schema', N'dbo', N'table', N'__RefactorLog'
END
GO
IF NOT EXISTS (SELECT OperationKey FROM [dbo].[__RefactorLog] WHERE OperationKey = 'fb06cac1-6bc8-4a62-a709-3e0c5ec0fe29')
INSERT INTO [dbo].[__RefactorLog] (OperationKey) values ('fb06cac1-6bc8-4a62-a709-3e0c5ec0fe29')
IF NOT EXISTS (SELECT OperationKey FROM [dbo].[__RefactorLog] WHERE OperationKey = '7aee1f85-891b-4139-bc27-d9759cd7907d')
INSERT INTO [dbo].[__RefactorLog] (OperationKey) values ('7aee1f85-891b-4139-bc27-d9759cd7907d')
IF NOT EXISTS (SELECT OperationKey FROM [dbo].[__RefactorLog] WHERE OperationKey = '900b535f-8a27-4845-8db6-507287b08962')
INSERT INTO [dbo].[__RefactorLog] (OperationKey) values ('900b535f-8a27-4845-8db6-507287b08962')
IF NOT EXISTS (SELECT OperationKey FROM [dbo].[__RefactorLog] WHERE OperationKey = '4037b5f7-269d-42a4-a451-aeb4c59565a7')
INSERT INTO [dbo].[__RefactorLog] (OperationKey) values ('4037b5f7-269d-42a4-a451-aeb4c59565a7')
IF NOT EXISTS (SELECT OperationKey FROM [dbo].[__RefactorLog] WHERE OperationKey = '06b6afe4-064c-476f-8889-cc0a617ee859')
INSERT INTO [dbo].[__RefactorLog] (OperationKey) values ('06b6afe4-064c-476f-8889-cc0a617ee859')
IF NOT EXISTS (SELECT OperationKey FROM [dbo].[__RefactorLog] WHERE OperationKey = 'ba311bd0-cd3e-4370-984b-f42d3fed55fe')
INSERT INTO [dbo].[__RefactorLog] (OperationKey) values ('ba311bd0-cd3e-4370-984b-f42d3fed55fe')
IF NOT EXISTS (SELECT OperationKey FROM [dbo].[__RefactorLog] WHERE OperationKey = 'f9c4a3aa-7e64-4011-b229-46faf411aafd')
INSERT INTO [dbo].[__RefactorLog] (OperationKey) values ('f9c4a3aa-7e64-4011-b229-46faf411aafd')
IF NOT EXISTS (SELECT OperationKey FROM [dbo].[__RefactorLog] WHERE OperationKey = '997e0375-919c-4498-ae0e-abdec281b126')
INSERT INTO [dbo].[__RefactorLog] (OperationKey) values ('997e0375-919c-4498-ae0e-abdec281b126')
IF NOT EXISTS (SELECT OperationKey FROM [dbo].[__RefactorLog] WHERE OperationKey = '9df434b3-0abc-4e53-90bc-4366ba924577')
INSERT INTO [dbo].[__RefactorLog] (OperationKey) values ('9df434b3-0abc-4e53-90bc-4366ba924577')

GO

GO
PRINT N'Checking existing data against newly created constraints';


GO
USE [$(DatabaseName)];


GO
ALTER TABLE [dbo].[Projects] WITH CHECK CHECK CONSTRAINT [FK_PROJECTS_MANAGER];

ALTER TABLE [dbo].[Projects] WITH CHECK CHECK CONSTRAINT [FK_PROJECTS_PROJECTS];

ALTER TABLE [dbo].[Timesheets] WITH CHECK CHECK CONSTRAINT [FK_TIMESHEETS_PROJECTS];

ALTER TABLE [dbo].[Timesheets] WITH CHECK CHECK CONSTRAINT [FK_TIMESHEETS_MANAGERS];

ALTER TABLE [dbo].[Timesheets] WITH CHECK CHECK CONSTRAINT [FK_TIMESHEETS_USERS];

ALTER TABLE [dbo].[Users] WITH CHECK CHECK CONSTRAINT [FK_USERS_PROJECT];


GO
PRINT N'Update complete.';


GO
